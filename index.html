<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>ComplexViewer Demo</title>
    <meta content="ComplexViewer Demo" name="ComplexViewer Demo">
    <meta content="initial-scale=1, maximum-scale=1" name="viewport">
    <!-- css -->
    <link href="./css/reset.css" rel="stylesheet" type='text/css'>
    <link href="./css/style.css" rel="stylesheet" type='text/css'>
    <link href="./css/demo.css" rel="stylesheet" type='text/css'>
    <!--libraries-->
    <script src="./dist/complexviewer.js" type="text/javascript"></script>
    <!-- example data info -->
    <script src="./data/index.js" type="text/javascript"></script>
</head>
<body>
<!-- Main -->
<div id="main">

    <div class="page-header">
        <i class="fa fa-github" onclick="window.location = 'https://github.com/MICommunity/ComplexViewer';"
           style="margin-right:5px;" title="GitHub project"></i>
        <h1><a href="https://doi.org/10.1093/bioinformatics/btx497" target="_blank"
               title="Publication">ComplexViewer</a></h1>
        <div class="examples-dropdown">
            <label for="dataSets">Example:</label>
            <select class="noShrink" id="dataSets"
                    onChange="/*document.getElementById('chkexpansion').checked = true;*/loadData();"></select>
            <br>
        </div>
    </div>

    <div id="centre">

        <!--        <div id="detailsDiv"></div>-->

        <div id="middleDiv">
            <div id="innerMiddleDiv">
                <div id="networkDiv"></div>
                <div id="symbolKeyDiv">
                    <table>
                        <tr>
                            <td>
                                <div style="float:right">
                                    <img alt="Bioactive Entity" src="./src/imgs/key-svg/molecule-set.svg">
                                </div>
                            </td>
                            <td>Molecule Set</td>
                        </tr>
                        <tr>
                            <td>
                                <div style="float:right">
                                    <img alt="Bioactive Entity" src="./src/imgs/key-svg/small-molecule.svg">
                                </div>
                            </td>
                            <td>Bioactive Entity</td>
                        </tr>

                        <tr>
                            <td>
                                <div style="float:right">
                                    <img alt="Gene" src="./src/imgs/key-svg/gene.svg">
                                </div>
                            </td>
                            <td>Gene</td>
                        </tr>
                        <tr>
                            <td>
                                <div style="float:right">
                                    <img alt="DNA" src="./src/imgs/key-svg/dna.svg">
                                </div>
                            </td>
                            <td>DNA</td>
                        </tr>
                        <tr>
                            <td>
                                <div style="float:right">
                                    <img alt="RNA" src="./src/imgs/key-svg/rna.svg">
                                </div>
                            </td>
                            <td>RNA</td>
                        </tr>
                        <tr style="border: 1px grey;">
                            <td>
                                <div style="float:right">
                                    <img alt="Protein" src="./src/imgs/key-svg/protein-circle.svg">
                                </div>
                                <div style="float:right">
                                    <img alt="Protein" src="./src/imgs/key-svg/protein-bar.svg">
                                </div>
                            </td>
                            <td>Protein - click to toggle between circle and bar</td>
                        </tr>
                    </table>
                    <div class="controls" style="height:46px;">Proteins:
                        <button class="btn btn-1 btn-1a" onclick="cv.expandAll();">Expand</button>
                        <button class="btn btn-1 btn-1a" onclick="cv.collapseAll();">Collapse</button>
                    </div>
                    <div id="colors"></div>

                </div><!-- legend -->

            </div> <!-- innerMiddleDiv -->

            <div>
                <div class="controls">
                    <div>
                        Annotations:

                        <input type="checkbox" id="mifeatures" name="mifeatures" value="MIFEATURES" checked
                               onchange="setAnnotations(this);">
                        <label for="mifeatures"> MI Features</label>
                        <input type="checkbox" id="uniprotkb" name="uniprotkb" value="UNIPROTKB"
                               onchange="setAnnotations(this);">
                        <label for="uniprotkb"> UniprotKB Domains</label>
                        <input type="checkbox" id="superfamily" name="superfamily" value="SUPERFAMILY"
                               onchange="setAnnotations(this);">
                        <label for="superfamily"> Superfamily</label>
                        <input type="checkbox" id="interactor" name="interactor" value="INTERACTOR"
                               onchange="setAnnotations(this);">
                        <label for="interactor"> Interactor</label>
                    </div>
                    <div class="other-controls">
                        <!-- <label>&nbsp;&nbsp;Expand Stoich.
                        <input checked onclick="loadData()" id="chkexpansion" value="expansion" type="checkbox">
                        </label> -->
                        <button class="btn btn-1 btn-1a" onclick="cv.autoLayout();" style="display:inline">Layout
                        </button>
                        <button class="btn btn-1 btn-1a" onclick="exportSVG();" style="display:inline">Export Graphic
                        </button>
                    </div>

                </div>

            </div> <!-- bottom bar -->

        </div> <!-- middleDiv -->

    </div> <!-- centreDiv -->

    <div class="logoBar">
        <a class="logo" href="http://rappsilberlab.org/" target="_blank"><img src="images/logos/rappsilber-logo.png"
                                                                              alt="Rappsilber Laboratory"></a>
        <a class="logo" href="http://www.ed.ac.uk/" target="_blank"><img src="./images/logos/eduni.jpeg"
                                                                         alt="Edinburgh University"></a>
        <a class="logo" href="http://www.wcb.ed.ac.uk/" target="_blank"><img src="images/logos/wtccb.png"
                                                                             alt="Wellcome Trust Centre for Cell Biology"></a>
        <a class="logo" href="http://www.ebi.ac.uk/" target="_blank"><img src="images/logos/ebi-logo.jpeg"
                                                                          alt="European Bioinformatics Institute"></a>
        <a class="logo" href="http://intermine.org/" target="_blank"><img src="./images/logos/intermine.png"
                                                                          alt="Intermine"></a>
        <a class="logo" href="https://www.cam.ac.uk/" target="_blank"><img src="./images/logos/cambridge-blue.png"
                                                                           alt="Cambridge University"></a>
    </div>

</div><!-- MAIN -->

<script type="text/javascript">
    //<![CDATA[

    const networkTargetDiv = document.getElementById("networkDiv");
    cv = new complexviewer.App(networkTargetDiv);
    cv.addColorSchemeKey(document.getElementById("colors"));
    //todo - er, use css
    cv.svgElement.setAttribute("style", "display: -webkit-box;display: -moz-box;display: -ms-flexbox; display: -webkit-flex;display: flex;flex-grow:1;");

    for (let example of exampleIndex) {
        const dataSetsSelect = document.getElementById("dataSets");
        const opt = document.createElement("option");
        opt.value = example.ac;
        opt.innerHTML = example.name;
        dataSetsSelect.appendChild(opt);
    }

    loadData();

    function loadData() {
        cv.clear();
        const dataSetsSelect = document.getElementById("dataSets");
        const path = "./data/" + dataSetsSelect.options[dataSetsSelect.selectedIndex].value + ".json";
        d3.json(path, function (data) {
            cv.readMIJSON(data);//, matrixExpansion);
            resetAnnotations();
        });
    }

    function resetAnnotations() {
        let checkbox = document.getElementById("mifeatures");
        cv.showAnnotations(checkbox.value, checkbox.checked);
        checkbox = document.getElementById("uniprotkb");
        cv.showAnnotations(checkbox.value, checkbox.checked);
        checkbox = document.getElementById("superfamily");
        cv.showAnnotations(checkbox.value, checkbox.checked);
        checkbox = document.getElementById("interactor");
        cv.showAnnotations(checkbox.value, checkbox.checked);
    }

    function setAnnotations(checkbox) {
        cv.showAnnotations(checkbox.value, checkbox.checked);
    }

    function exportSVG() {
        // todo
        const svgXML = cv.getSVG();
        const dataSetsSelect = document.getElementById("dataSets");
        download(svgXML, "application/svg", dataSetsSelect.options[dataSetsSelect.selectedIndex].value + ".svg");
    }

    function download(content, contentType, fileName) {
        var oldToNewTypes = {
            "application/svg": "image/svg+xml;charset=utf-8",
            "plain/text": "plain/text;charset=utf-8",
        };
        var newContentType = oldToNewTypes[contentType] || contentType;

        function dataURItoBlob(binary) {
            var array = [];
            var te;

            try {
                te = new TextEncoder("utf-8");
            } catch (e) {
                te = undefined;
            }

            if (te) {
                array = te.encode(binary); // html5 encoding api way
            } else {
                // https://stackoverflow.com/a/18729931/368214
                // fixes unicode bug
                for (var i = 0; i < binary.length; i++) {
                    var charcode = binary.charCodeAt(i);
                    if (charcode < 0x80) array.push(charcode);
                    else if (charcode < 0x800) {
                        array.push(0xc0 | (charcode >> 6),
                            0x80 | (charcode & 0x3f));
                    } else if (charcode < 0xd800 || charcode >= 0xe000) {
                        array.push(0xe0 | (charcode >> 12),
                            0x80 | ((charcode >> 6) & 0x3f),
                            0x80 | (charcode & 0x3f));
                    }
                    // surrogate pair
                    else {
                        i++;
                        // UTF-16 encodes 0x10000-0x10FFFF by
                        // subtracting 0x10000 and splitting the
                        // 20 bits of 0x0-0xFFFFF into two halves
                        charcode = 0x10000 + (((charcode & 0x3ff) << 10) |
                            (binary.charCodeAt(i) & 0x3ff));
                        array.push(0xf0 | (charcode >> 18),
                            0x80 | ((charcode >> 12) & 0x3f),
                            0x80 | ((charcode >> 6) & 0x3f),
                            0x80 | (charcode & 0x3f));
                    }
                }
            }

            return new Blob([new Uint8Array(array)], {
                type: newContentType
            });
        }

        var blob = dataURItoBlob(content);

        if (navigator.msSaveOrOpenBlob) {
            navigator.msSaveOrOpenBlob(blob, fileName);
        } else {
            var a = document.createElement("a");
            a.href = window.URL.createObjectURL(blob);
            // Give filename you wish to download
            a.download = fileName;
            a.style.display = "none";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(a.href); // clear up url reference to blob so it can be g.c.'ed
        }

        blob = null;
    }

    //]]>
</script>

</body>
</html>
